<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:include filename="common_properties.xacro" />

    <xacro:macro name="mobile_base">
        
        <!-- Base Footprint -->
        <link name="base_footprint" />

        <!-- Base Link -->
        <link name="base_link">
            <visual>
                <geometry>
                    <box size="0.6 0.4 0.2"/>
                </geometry>
                <origin xyz="0 0 0.1" rpy="0 0 0"/>
                <material name="blue"/>
            </visual>
            <collision>
                <geometry>
                    <box size="0.6 0.4 0.2"/>
                </geometry>
                <origin xyz="0 0 0.1" rpy="0 0 0"/>
            </collision>
            <xacro:box_inertia m="10.0" l="0.6" w="0.4" h="0.2" xyz="0 0 0.1" rpy="0 0 0"/>
        </link>

        <joint name="base_joint" type="fixed">
            <parent link="base_footprint"/>
            <child link="base_link"/>
            <origin xyz="0 0 0.1" rpy="0 0 0"/>
        </joint>

        <!-- Wheels - positioned at wheel center height -->
        <xacro:macro name="wheel" params="prefix y_reflect">
            <link name="${prefix}_wheel">
                <visual>
                    <geometry>
                        <cylinder radius="0.1" length="0.05"/>
                    </geometry>
                    <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
                    <material name="black"/>
                </visual>
                <collision>
                    <geometry>
                        <cylinder radius="0.1" length="0.05"/>
                    </geometry>
                    <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
                </collision>
                <xacro:cylinder_inertia m="1.0" r="0.1" h="0.05" xyz="0 0 0" rpy="${pi/2} 0 0"/>
            </link>

            <joint name="${prefix}_wheel_joint" type="continuous">
                <parent link="base_link"/>
                <child link="${prefix}_wheel"/>
                <origin xyz="-0.1 ${y_reflect*0.225} 0" rpy="0 0 0"/>
                <axis xyz="0 1 0"/>
            </joint>
        </xacro:macro>

        <xacro:wheel prefix="left" y_reflect="1"/>
        <xacro:wheel prefix="right" y_reflect="-1"/>

        <!-- Front Caster Wheel -->
        <link name="caster_wheel">
            <visual>
                <geometry>
                    <sphere radius="0.05"/>
                </geometry>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <material name="grey"/>
            </visual>
            <collision>
                <geometry>
                    <sphere radius="0.05"/>
                </geometry>
                <origin xyz="0 0 0" rpy="0 0 0"/>
            </collision>
            <xacro:sphere_inertia m="0.5" r="0.05" xyz="0 0 0" rpy="0 0 0"/>
        </link>

        <joint name="caster_wheel_joint" type="fixed">
            <parent link="base_link"/>
            <child link="caster_wheel"/>
            <origin xyz="0.2 0 -0.05" rpy="0 0 0"/>
        </joint>

        <!-- LiDAR -->
        <link name="lidar_link">
            <visual>
                <geometry>
                    <cylinder radius="0.05" length="0.04"/>
                </geometry>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <material name="red"/>
            </visual>
            <collision>
                <geometry>
                    <cylinder radius="0.05" length="0.04"/>
                </geometry>
                <origin xyz="0 0 0" rpy="0 0 0"/>
            </collision>
            <xacro:cylinder_inertia m="0.2" r="0.05" h="0.04" xyz="0 0 0" rpy="0 0 0"/>
        </link>

        <joint name="lidar_joint" type="fixed">
            <parent link="base_link"/>
            <child link="lidar_link"/>
            <origin xyz="0.2 0 0.12" rpy="0 0 0"/>
        </joint>

        <!-- Gazebo Plugins -->
        <gazebo>
            <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
                <left_joint>left_wheel_joint</left_joint>
                <right_joint>right_wheel_joint</right_joint>
                <wheel_separation>0.45</wheel_separation>
                <wheel_radius>0.1</wheel_radius>
                <max_linear_acceleration>1.0</max_linear_acceleration>
                <max_angular_acceleration>2.0</max_angular_acceleration>
                <odom_publish_frequency>50</odom_publish_frequency>
                <topic>cmd_vel</topic>
                <odom_topic>odom</odom_topic>
                <tf_topic>tf</tf_topic>
                <frame_id>odom</frame_id>
                <child_frame_id>base_footprint</child_frame_id>
            </plugin>

            <!-- Joint State Publisher -->
            <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
                <topic>joint_states</topic>
            </plugin>
        </gazebo>

        <gazebo reference="lidar_link">
            <sensor name="lidar" type="gpu_lidar">
                <pose>0 0 0 0 0 0</pose>
                <topic>scan</topic>
                <update_rate>10</update_rate>
                <lidar>
                    <scan>
                        <horizontal>
                            <samples>360</samples>
                            <resolution>1</resolution>
                            <min_angle>-3.14159</min_angle>
                            <max_angle>3.14159</max_angle>
                        </horizontal>
                    </scan>
                    <range>
                        <min>0.1</min>
                        <max>10.0</max>
                    </range>
                </lidar>
                <always_on>1</always_on>
                <visualize>true</visualize>
            </sensor>
        </gazebo>
        
        <!-- Wheel friction -->
        <gazebo reference="left_wheel">
            <collision>
                <surface>
                    <friction>
                        <ode>
                            <mu>1.0</mu>
                            <mu2>1.0</mu2>
                        </ode>
                    </friction>
                </surface>
            </collision>
        </gazebo>
        <gazebo reference="right_wheel">
            <collision>
                <surface>
                    <friction>
                        <ode>
                            <mu>1.0</mu>
                            <mu2>1.0</mu2>
                        </ode>
                    </friction>
                </surface>
            </collision>
        </gazebo>
        
        <!-- Caster - low friction -->
        <gazebo reference="caster_wheel">
            <collision>
                <surface>
                    <friction>
                        <ode>
                            <mu>0.0</mu>
                            <mu2>0.0</mu2>
                        </ode>
                    </friction>
                </surface>
            </collision>
        </gazebo>

    </xacro:macro>
</robot>
