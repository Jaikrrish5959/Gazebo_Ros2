<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:macro name="mobile_base">
        
        <!-- Base Footprint -->
        <link name="base_footprint" />

        <!-- Base Link (Chassis) -->
        <link name="base_link">
            <visual>
                <geometry>
                    <box size="0.8 0.5 0.2"/>
                </geometry>
                <origin xyz="0 0 0.15" rpy="0 0 0"/>
                <material name="yellow"> <!-- Construction vehicle color -->
                    <color rgba="1.0 0.8 0.0 1.0"/>
                </material>
            </visual>
            <collision>
                <geometry>
                    <box size="0.8 0.5 0.2"/>
                </geometry>
                <origin xyz="0 0 0.15" rpy="0 0 0"/>
            </collision>
            <inertial>
                <mass value="20.0"/>
                <origin xyz="0 0 0.15" rpy="0 0 0"/>
                <inertia ixx="0.5" ixy="0.0" ixz="0.0" iyy="1.0" iyz="0.0" izz="1.0"/>
            </inertial>
        </link>

        <joint name="base_joint" type="fixed">
            <parent link="base_footprint"/>
            <child link="base_link"/>
            <origin xyz="0 0 0.0" rpy="0 0 0"/>
        </joint>

        <!-- Wheels Macro -->
        <xacro:macro name="wheel" params="prefix x_reflect y_reflect">
            <link name="${prefix}_wheel">
                <visual>
                    <geometry>
                        <cylinder radius="0.15" length="0.08"/>
                    </geometry>
                    <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
                    <material name="black">
                        <color rgba="0.1 0.1 0.1 1.0"/>
                    </material>
                </visual>
                <collision>
                    <geometry>
                        <cylinder radius="0.15" length="0.08"/>
                    </geometry>
                    <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
                    <surface>
                        <friction>
                            <ode>
                                <mu>1.0</mu>
                                <mu2>1.0</mu2>
                            </ode>
                        </friction>
                    </surface>
                </collision>
                <inertial>
                    <mass value="2.0"/>
                    <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
                    <inertia ixx="0.02" ixy="0.0" ixz="0.0" iyy="0.02" iyz="0.0" izz="0.04"/>
                </inertial>
            </link>

            <joint name="${prefix}_wheel_joint" type="continuous">
                <parent link="base_link"/>
                <child link="${prefix}_wheel"/>
                <origin xyz="${x_reflect*0.25} ${y_reflect*0.3} 0.15" rpy="0 0 0"/> <!-- centered vertically relative to base origin which is at ground? No base origin is at 0, wheels need to lift chassis. Wait. Usually base_footprint is at 0, base_link at some height. Here base_link visual is at z=0.15. Wheels radius 0.15. So wheel center at z=0.15 is correct. -->
                <axis xyz="0 1 0"/>
            </joint>
        </xacro:macro>

        <xacro:wheel prefix="front_left" x_reflect="1" y_reflect="1"/>
        <xacro:wheel prefix="front_right" x_reflect="1" y_reflect="-1"/>
        <xacro:wheel prefix="rear_left" x_reflect="-1" y_reflect="1"/>
        <xacro:wheel prefix="rear_right" x_reflect="-1" y_reflect="-1"/>

        <!-- Gazebo Plugin for Skid Steer Drive -->
        <!-- In recent Gazebo versions (Harmonic/Fortress/etc), DiffDrive works for 4 wheels if configured or we use SkidSteer. 
             Ideally use diff_drive with multiple wheels per side or separate plugin. 
             Standard gazebo_ros_diff_drive supports 2 wheels. gazebo_ros_skid_steer_drive is older.
             Wait, 'gz-sim-diff-drive-system' in the previous file only had 2 wheels.
             For 4 wheels, we can use 'diff_drive' plugin and just drive rear wheels (like a car) or all wheels if we link them.
             Or use 'ackermann_steering' if we want real car steering.
             Let's stick to simple DiffDrive for now, maybe just powering the rear wheels and letting front caster? 
             But a "car" implies 4 wheels. 
             If I use diff drive on 4 wheels, I need a plugin that supports it. 
             The standard 'diff_drive' plugin usually takes 1 left and 1 right joint. 
             We can set up transmission to link front and rear wheels, or just use 2 powered wheels and 2 caster wheels (hidden casters or low friction front wheels).
             
             Actually, for a "skid steer" 4-wheel robot, we can use the 'diff_drive' plugin and just specify the front and rear wheels if the plugin supports it (some versions do), 
             OR use the 'skid_steer_drive' plugin.
             
             Let's try using `libgazebo_ros_diff_drive.so` and publish to `cmd_vel`. 
             If using Gazebo Classic, `skid_steer_drive_controller` is good.
             If using Ignition/Gazebo Sim (the new one, `gz-sim`), `diff-drive` system works but usually expects 2 joints.
             
             Let's check what `mobile_manipulator_sim` used: `gz-sim-diff-drive-system`. 
             I will assume we are using Ignition/Gazebo Sim as per the `gz-sim` prefix.
             
             To make 4 wheels work with `gz-sim-diff-drive-system`, we can just power the rear wheels and let the front wheels be free-rolling (with low friction for turning) OR we can use a second diff drive plugin for the front wheels listening to the same topic.
             
             Let's go with: Power rear wheels, front wheels are continuous but not powered (or caster-like).
             But a 4-wheel car usually has steering.
             
             Alternative: Skid steer (tank turn).
             To achieve skid steer in Gazebo Sim, we can just power all 4 wheels. We can add two `DiffDrive` plugins, one for front, one for rear?
             
             Let's try to power all 4 wheels for maximum "hydraulic/construction" feel.
        -->
        
        <gazebo>
            <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
                <!-- Rear wheels -->
                <left_joint>rear_left_wheel_joint</left_joint>
                <right_joint>rear_right_wheel_joint</right_joint>
                <wheel_separation>0.6</wheel_separation>
                <wheel_radius>0.15</wheel_radius>
                <max_linear_acceleration>1.0</max_linear_acceleration>
                <odom_publish_frequency>30</odom_publish_frequency>
                <topic>cmd_vel</topic>
                <odom_topic>odom</odom_topic>
                <tf_topic>tf</tf_topic>
                <frame_id>odom</frame_id>
                <child_frame_id>base_footprint</child_frame_id>
            </plugin>
            
             <!-- Front wheels - mimicking skid steer by driving them too? Or just let them roll? 
                  If we don't drive them, it's a rear-wheel drive car. 
                  But without steering, it won't turn well unless front wheels have low friction (sliding).
             -->
             <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
                <left_joint>front_left_wheel_joint</left_joint>
                <right_joint>front_right_wheel_joint</right_joint>
                <wheel_separation>0.6</wheel_separation>
                <wheel_radius>0.15</wheel_radius>
                <topic>cmd_vel</topic> <!-- Listen to same topic -->
                 <odom_publish_frequency>0</odom_publish_frequency> <!-- Don't publish odom twice -->
            </plugin>
        </gazebo>

    </xacro:macro>
</robot>
